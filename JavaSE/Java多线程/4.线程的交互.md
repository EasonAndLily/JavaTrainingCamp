# 线程的交互

![java-thread-interactive](https://tva1.sinaimg.cn/large/008eGmZEly1gmz5lv3h1fj30rs0ij1kx.jpg)

合理的使用Java多线程可以更好地利用服务器资源。一般来讲，线程内部有自己私有的线程上下文，互不干扰。但是当我们需要多个线程之间相互协作的时候，就需要我们掌握Java线程的通信方式。本文将介绍Java线程之间的几种交互方式。

## 线程安全带来的问题

继续使用我们上节课的火车站售票的案例，我们有三个窗口来负责售票，每次每个窗口可以出售一张车票，代码实现如下：

先定义一个`Tickets`类, 负责管理总车票和售票等事宜：

```java
import com.sun.deploy.util.StringUtils;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class Tickets {
    private static List<String> tickets = Stream.of("1A", "1B", "1D", "1F", "2A", "2B", "2D", "2F", "3A", "3B")
            .collect(Collectors.toList());

    public static boolean saleTickets() {
        if (tickets.size() > 0) {
            String ticket = tickets.remove(0);
            System.out.println(Thread.currentThread().getName() + "出售车票：" + ticket +
                    "，剩余车票：" + StringUtils.join(tickets, ","));
            return true;
        }
        System.out.println("无票可售！");
        return false;
    }
}
```

在定义一个售票的线程类`SaleTicketsThread`:

```java
public class SaleTicketsThread implements Runnable {
    @Override
    public void run() {
        while (true) {
            if (Tickets.saleTickets()) {
                try {
                    Thread.currentThread().sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            } else {
                break;
            }
        }
    }
}
```

最后在`Main`方法中，定义三个售票窗口，出售此次车票：

```java
public class Main {
    public static void main(String[] args) {
        SaleTicketsThread salesTicketsThread = new SaleTicketsThread();
        Thread wuchang = new Thread(salesTicketsThread, "武昌火车站售票窗口");
        Thread wuhan = new Thread(salesTicketsThread, "武汉火车站售票窗口");
        Thread hankou = new Thread(salesTicketsThread, "汉口火车站售票窗口");
        wuchang.start();
        wuhan.start();
        hankou.start();
    }
}
```

运行结果如下：

```bash
汉口火车站售票窗口出售车票：1A，剩余车票：1D,1F,2A,2D,2F,3A,3B
汉口火车站售票窗口出售车票：2A，剩余车票：2D,2F,3A,3B,3B
武昌火车站售票窗口出售车票：1D，剩余车票：2D,2F,3A,3B,3B
武汉火车站售票窗口出售车票：1D，剩余车票：2D,2F,3A,3B,3B
武昌火车站售票窗口出售车票：2D，剩余车票：2F,3A,3B
汉口火车站售票窗口出售车票：2D，剩余车票：2F,3A,3B
武汉火车站售票窗口出售车票：2D，剩余车票：2F,3A,3B
汉口火车站售票窗口出售车票：2F，剩余车票：3B
武汉火车站售票窗口出售车票：3B，剩余车票：
武昌火车站售票窗口出售车票：2F，剩余车票：3B
无票可售！
无票可售！
无票可售！
```

上面的结果让我们大吃一惊，我们发现一张车票有可能被出售多次，同时当所有车票被某个窗口出售完成之后，其他的窗口没有同步过来，还在继续售票。这就是线程安全问题，根本原因就在于多个线程并发操作一个变量，当一个线程在修改数据的过程中，其他线程并不知晓此次修改，从而造成数据异常。

